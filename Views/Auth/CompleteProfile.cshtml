@{
    ViewData["Title"] = "Complete Profile";
    Layout = "~/Views/Shared/_Auth.cshtml";
}

<section class="min-h-[calc(100vh-120px)] flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-2xl space-y-8">

        <!-- Header -->
        <div class="flex flex-col gap-2 text-center">
            <p class="text-xs font-semibold uppercase tracking-[0.16em] text-sky-500">
                Step <span id="step-label">1</span> of 3
            </p>
            <h1 class="text-xl font-semibold text-slate-900 dark:text-slate-50 md:text-2xl">
                Complete your trading profile
            </h1>
            <p class="text-xs text-slate-500 dark:text-slate-400 md:text-sm">
                Tell us a bit more about you so we can set up the right account experience.
            </p>
        </div>

        <!-- Stepper -->
        <div class="flex items-center justify-between gap-3">
            <!-- Step 1 -->
            <div class="flex flex-1 items-center gap-3">
                <div id="step-pill-1"
                    class="flex h-8 min-w-[2.5rem] items-center justify-center rounded-full border border-sky-500 bg-sky-500/10
                            text-xs font-semibold text-sky-600 dark:border-sky-400 dark:bg-sky-400/10 dark:text-sky-300">
                    1
                </div>
                <div class="hidden flex-1 border-t border-dashed border-slate-300 dark:border-slate-700 md:block"></div>
            </div>

            <!-- Step 2 -->
            <div class="flex flex-1 items-center gap-3">
                <div id="step-pill-2" class="flex h-8 min-w-[2.5rem] items-center justify-center rounded-full border border-slate-300
                            text-xs font-semibold text-slate-500
                            dark:border-slate-700 dark:text-slate-400">
                    2
                </div>
                <div class="hidden flex-1 border-t border-dashed border-slate-300 dark:border-slate-700 md:block"></div>
            </div>

            <!-- Step 3 -->
            <div class="flex flex-1 items-center gap-3">
                <div id="step-pill-3" class="flex h-8 min-w-[2.5rem] items-center justify-center rounded-full border border-slate-300
                            text-xs font-semibold text-slate-500
                            dark:border-slate-700 dark:text-slate-400">
                    3
                </div>
            </div>
        </div>

        @using (Html.BeginForm("CompleteProfile", "Account", FormMethod.Post, new
        {
            @class = "space-y-8",
            id =
                "complete-profile-form"
        }))
        {
            @Html.AntiForgeryToken()

            <!-- STEP 1: BASIC INFO -->
            <div id="step-1" class="space-y-5">
                <div class="space-y-1.5">
                    <label for="first-name" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        First name
                    </label>
                    <input id="first-name" name="FirstName" type="text" autocomplete="given-name"
                        class="w-full rounded-lg border border-slate-300 bg-white/95 px-3 py-2 text-sm
                                      text-slate-900 shadow-sm placeholder:text-slate-400
                                      focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                      dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500" />
                    <p id="first-name-error" class="mt-1 text-[11px] text-red-400 hidden"></p>
                    @Html.ValidationMessage("FirstName", "", new { @class = "text-[11px] text-red-400" })
                </div>

                <div class="space-y-1.5">
                    <label for="last-name" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        Last name
                    </label>
                    <input id="last-name" name="LastName" type="text" autocomplete="family-name"
                        class="w-full rounded-lg border border-slate-300 bg-white/95 px-3 py-2 text-sm
                                      text-slate-900 shadow-sm placeholder:text-slate-400
                                      focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                      dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500" />
                    <p id="last-name-error" class="mt-1 text-[11px] text-red-400 hidden"></p>
                    @Html.ValidationMessage("LastName", "", new { @class = "text-[11px] text-red-400" })
                </div>
            </div>

            <!-- STEP 2: LOCATION & TIME -->
            <div id="step-2" class="hidden space-y-5">
                <!-- Country -->
                <div class="space-y-1.5">
                    <label for="country" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        Country of residence
                    </label>
                    <div class="relative">
                        <select id="country" name="Country"
                            class="w-full appearance-none rounded-lg border border-slate-300 bg-white/95 px-3 py-2 pr-9 text-sm
                                           text-slate-900 shadow-sm placeholder:text-slate-400
                                           focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                           dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500">
                            <option value="">Select country</option>
                            <option value="NG">Nigeria</option>
                            <option value="ZA">South Africa</option>
                            <option value="GB">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="AE">United Arab Emirates</option>
                        </select>
                        <span
                            class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400 dark:text-slate-500">
                            <svg viewBox="0 0 20 20" class="h-4 w-4" fill="none">
                                <path d="M5 7l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                    <p id="country-error" class="mt-1 text-[11px] text-red-400 hidden"></p>
                    @Html.ValidationMessage("Country", "", new { @class = "text-[11px] text-red-400" })
                </div>

                <!-- Time zone -->
                <div class="space-y-1.5">
                    <label for="time-zone" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        Time zone
                    </label>
                    <div class="relative">
                        <select id="time-zone" name="TimeZone"
                            class="w-full appearance-none rounded-lg border border-slate-300 bg-white/95 px-3 py-2 pr-9 text-sm
                                           text-slate-900 shadow-sm placeholder:text-slate-400
                                           focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                           dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500">
                            <option value="">Select time zone</option>
                            <option value="Africa/Lagos">(GMT+1) Africa / Lagos</option>
                            <option value="Africa/Johannesburg">(GMT+2) Africa / Johannesburg</option>
                            <option value="Europe/London">(GMT) Europe / London</option>
                            <option value="Etc/UTC">UTC</option>
                            <option value="America/New_York">(GMT-5) America / New York</option>
                        </select>
                        <span
                            class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400 dark:text-slate-500">
                            <svg viewBox="0 0 20 20" class="h-4 w-4" fill="none">
                                <path d="M5 7l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                    <p id="time-zone-error" class="mt-1 text-[11px] text-red-400 hidden"></p>
                    @Html.ValidationMessage("TimeZone", "", new { @class = "text-[11px] text-red-400" })
                </div>
            </div>

            <!-- STEP 3: ACCOUNT PREFERENCES -->
            <div id="step-3" class="hidden space-y-5">
                <!-- Account currency -->
                <div class="space-y-1.5">
                    <label for="account-currency" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        Account base currency
                    </label>
                    <div class="relative">
                        <select id="account-currency" name="AccountCurrency"
                            class="w-full appearance-none rounded-lg border border-slate-300 bg-white/95 px-3 py-2 pr-9 text-sm
                                           text-slate-900 shadow-sm placeholder:text-slate-400
                                           focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                           dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500">
                            <option value="">Select currency</option>
                            <option value="USD">USD – US Dollar</option>
                            <option value="EUR">EUR – Euro</option>
                            <option value="GBP">GBP – British Pound</option>
                            <option value="NGN">NGN – Nigerian Naira</option>
                            <option value="ZAR">ZAR – South African Rand</option>
                        </select>
                        <span
                            class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400 dark:text-slate-500">
                            <svg viewBox="0 0 20 20" class="h-4 w-4" fill="none">
                                <path d="M5 7l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                    <p id="account-currency-error" class="mt-1 text-[11px] text-red-400 hidden"></p>
                    @Html.ValidationMessage("AccountCurrency", "", new { @class = "text-[11px] text-red-400" })
                </div>

                <!-- Account preference -->
                <div class="space-y-1.5">
                    <label for="account-preference" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        Account preference
                    </label>
                    <div class="relative">
                        <select id="account-preference" name="AccountPreference"
                            class="w-full appearance-none rounded-lg border border-slate-300 bg-white/95 px-3 py-2 pr-9 text-sm
                                           text-slate-900 shadow-sm placeholder:text-slate-400
                                           focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                           dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500">
                            <option value="">Select preference</option>
                            <option value="standard">Standard account</option>
                            <option value="ecn">ECN / Raw spread</option>
                            <option value="islamic">Swap-free / Islamic account</option>
                            <option value="copy">Copy-trading focused</option>
                        </select>
                        <span
                            class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400 dark:text-slate-500">
                            <svg viewBox="0 0 20 20" class="h-4 w-4" fill="none">
                                <path d="M5 7l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                    <p id="account-preference-error" class="mt-1 text-[11px] text-red-400 hidden"></p>
                    @Html.ValidationMessage("AccountPreference", "", new { @class = "text-[11px] text-red-400" })
                </div>

                <!-- Trading style (optional) -->
                <div class="space-y-1.5">
                    <label for="trading-style" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        Trading style (optional)
                    </label>
                    <div class="relative">
                        <select id="trading-style" name="TradingStyle"
                            class="w-full appearance-none rounded-lg border border-slate-300 bg-white/95 px-3 py-2 pr-9 text-sm
                                           text-slate-900 shadow-sm placeholder:text-slate-400
                                           focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                           dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500">
                            <option value="">Select your trading style</option>
                            <option value="scalping">Scalping</option>
                            <option value="day">Day trading</option>
                            <option value="swing">Swing trading</option>
                            <option value="position">Position trading</option>
                            <option value="investor">Long-term investor</option>
                        </select>
                        <span
                            class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400 dark:text-slate-500">
                            <svg viewBox="0 0 20 20" class="h-4 w-4" fill="none">
                                <path d="M5 7l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                </div>

                <!-- Risk level (optional) -->
                <div class="space-y-1.5">
                    <label for="risk-level" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
                        Risk tolerance (optional)
                    </label>
                    <div class="relative">
                        <select id="risk-level" name="RiskLevel"
                            class="w-full appearance-none rounded-lg border border-slate-300 bg-white/95 px-3 py-2 pr-9 text-sm
                                           text-slate-900 shadow-sm placeholder:text-slate-400
                                           focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500
                                           dark:border-slate-700 dark:bg-slate-900 dark:text-slate-50 dark:placeholder:text-slate-500">
                            <option value="">Select risk level</option>
                            <option value="conservative">Conservative</option>
                            <option value="moderate">Moderate</option>
                            <option value="aggressive">Aggressive</option>
                        </select>
                        <span
                            class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400 dark:text-slate-500">
                            <svg viewBox="0 0 20 20" class="h-4 w-4" fill="none">
                                <path d="M5 7l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="mt-4 flex items-center justify-between gap-3">
                <button type="button" id="back-btn" class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-transparent px-4 py-2 text-sm font-medium
                                   text-slate-700 hover:bg-slate-50
                                   disabled:cursor-not-allowed disabled:opacity-50
                                   dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-900" disabled>
                    Back
                </button>

                <button type="button" id="next-btn" class="inline-flex items-center justify-center rounded-lg bg-brandGold px-5 py-2 text-sm font-semibold
                                   text-slate-900 shadow-sm hover:bg-yellow-300
                                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brandGold/70">
                    Continue
                </button>

                <button type="submit" id="finish-btn" class="hidden inline-flex items-center justify-center rounded-lg bg-brandGold px-5 py-2 text-sm font-semibold
                                   text-slate-900 shadow-sm hover:bg-yellow-300
                                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brandGold/70">
                    Finish
                </button>
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('complete-profile-form');

            const steps = {
                1: document.getElementById('step-1'),
                2: document.getElementById('step-2'),
                3: document.getElementById('step-3')
            };

            const stepLabel = document.getElementById('step-label');
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');

            const stepPills = {
                1: document.getElementById('step-pill-1'),
                2: document.getElementById('step-pill-2'),
                3: document.getElementById('step-pill-3')
            };

            let currentStep = 1;

            // --- FIELD CONFIG FOR VALIDATION ---
            const fields = {
                firstName: {
                    input: document.getElementById('first-name'),
                    error: document.getElementById('first-name-error'),
                    required: true,
                    label: 'First name',
                    minLength: 2
                },
                lastName: {
                    input: document.getElementById('last-name'),
                    error: document.getElementById('last-name-error'),
                    required: true,
                    label: 'Last name',
                    minLength: 2
                },
                country: {
                    input: document.getElementById('country'),
                    error: document.getElementById('country-error'),
                    required: true,
                    label: 'Country of residence'
                },
                timeZone: {
                    input: document.getElementById('time-zone'),
                    error: document.getElementById('time-zone-error'),
                    required: true,
                    label: 'Time zone'
                },
                accountCurrency: {
                    input: document.getElementById('account-currency'),
                    error: document.getElementById('account-currency-error'),
                    required: true,
                    label: 'Account base currency'
                },
                accountPreference: {
                    input: document.getElementById('account-preference'),
                    error: document.getElementById('account-preference-error'),
                    required: true,
                    label: 'Account preference'
                }
            };

            // Map fields to steps
            const stepFieldMap = {
                1: ['firstName', 'lastName'],
                2: ['country', 'timeZone'],
                3: ['accountCurrency', 'accountPreference']
            };

            // --- VALIDATION HELPERS ---

            function setInvalid(fieldConfig, message) {
                if (!fieldConfig || !fieldConfig.input || !fieldConfig.error) return;

                fieldConfig.error.textContent = message;
                fieldConfig.error.classList.remove('hidden');

                fieldConfig.input.classList.remove(
                    'border-slate-300',
                    'dark:border-slate-700',
                    'border-emerald-500'
                );
                fieldConfig.input.classList.add('border-red-500');
            }

            function setValid(fieldConfig) {
                if (!fieldConfig || !fieldConfig.input || !fieldConfig.error) return;

                fieldConfig.error.textContent = '';
                fieldConfig.error.classList.add('hidden');

                fieldConfig.input.classList.remove('border-red-500');
                fieldConfig.input.classList.remove('border-slate-300', 'dark:border-slate-700');
                fieldConfig.input.classList.add('border-emerald-500');
            }

            function setNeutral(fieldConfig) {
                if (!fieldConfig || !fieldConfig.input || !fieldConfig.error) return;

                fieldConfig.error.textContent = '';
                fieldConfig.error.classList.add('hidden');

                fieldConfig.input.classList.remove('border-red-500', 'border-emerald-500');
                fieldConfig.input.classList.add('border-slate-300', 'dark:border-slate-700');
            }

            function validateField(key) {
                const cfg = fields[key];
                if (!cfg || !cfg.input) return true;

                const value = (cfg.input.value || '').trim();

                if (!value) {
                    if (cfg.required) {
                        setInvalid(cfg, `${cfg.label} is required.`);
                        return false;
                    } else {
                        setNeutral(cfg);
                        return true;
                    }
                }

                if (cfg.minLength && value.length < cfg.minLength) {
                    setInvalid(cfg, `${cfg.label} must be at least ${cfg.minLength} characters.`);
                    return false;
                }

                setValid(cfg);
                return true;
            }

            function validateStep(step) {
                const keys = stepFieldMap[step] || [];
                let isValid = true;

                keys.forEach(k => {
                    const ok = validateField(k);
                    if (!ok) isValid = false;
                });

                return isValid;
            }

            function updateStepUI() {
                // Panels
                Object.keys(steps).forEach(s => {
                    if (parseInt(s, 10) === currentStep) {
                        steps[s].classList.remove('hidden');
                    } else {
                        steps[s].classList.add('hidden');
                    }
                });

                // Pills
                Object.keys(stepPills).forEach(s => {
                    const pill = stepPills[s];
                    const stepNumber = parseInt(s, 10);

                    pill.className =
                        'flex h-8 min-w-[2.5rem] items-center justify-center rounded-full border text-xs font-semibold';

                    if (stepNumber < currentStep) {
                        pill.classList.add(
                            'border-emerald-500',
                            'bg-emerald-500/10',
                            'text-emerald-600',
                            'dark:border-emerald-400',
                            'dark:bg-emerald-400/10',
                            'dark:text-emerald-300'
                        );
                    } else if (stepNumber === currentStep) {
                        pill.classList.add(
                            'border-sky-500',
                            'bg-sky-500/10',
                            'text-sky-600',
                            'dark:border-sky-400',
                            'dark:bg-sky-400/10',
                            'dark:text-sky-300'
                        );
                    } else {
                        pill.classList.add(
                            'border-slate-300',
                            'text-slate-500',
                            'dark:border-slate-700',
                            'dark:text-slate-400'
                        );
                    }
                });

                // Buttons & label
                stepLabel.textContent = currentStep.toString();
                backBtn.disabled = currentStep === 1;
                if (currentStep === 3) {
                    nextBtn.classList.add('hidden');
                    finishBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    finishBtn.classList.add('hidden');
                }
            }

            // --- WIRE BLUR EVENTS FOR INLINE VALIDATION ---
            Object.keys(fields).forEach(key => {
                const cfg = fields[key];
                if (!cfg || !cfg.input) return;

                cfg.input.addEventListener('blur', () => {
                    validateField(key);
                });

                cfg.input.addEventListener('input', () => {
                    validateField(key);
                });
            });

            // --- NAVIGATION BUTTONS ---
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    if (currentStep > 1) {
                        currentStep -= 1;
                        updateStepUI();
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (!validateStep(currentStep)) return;

                    if (currentStep < 3) {
                        currentStep += 1;
                        updateStepUI();
                    }
                });
            }

            if (form && finishBtn) {
                form.addEventListener('submit', function (e) {
                    const allStepsValid =
                        validateStep(1) && validateStep(2) && validateStep(3);

                    if (!allStepsValid) {
                        e.preventDefault();
                        if (!validateStep(1)) currentStep = 1;
                        else if (!validateStep(2)) currentStep = 2;
                        else currentStep = 3;

                        updateStepUI();
                        return;
                    }
                });
            }

            // Initialize
            updateStepUI();
        })();
    </script>
}